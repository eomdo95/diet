<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#0f0f13" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="ë‹¤ì´ì–´íŠ¸" />
  <title>ë‹¤ì´ì–´íŠ¸ íŠ¸ë˜ì»¤</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #0f0f13;
      --card: #1a1a24;
      --border: #2a2a38;
      --accent: #a3e635;
      --text: #e8e8e8;
      --muted: #666;
      --green: #4ade80;
      --red: #f87171;
      --blue: #60a5fa;
      --purple: #a78bfa;
      --yellow: #fbbf24;
    }
    html, body { height: 100%; background: var(--bg); color: var(--text); font-family: 'Noto Sans KR', sans-serif; overscroll-behavior: none; }
    body { display: flex; justify-content: center; }
    #root { width: 100%; max-width: 480px; min-height: 100vh; position: relative; padding-bottom: 80px; }
    ::-webkit-scrollbar { display: none; }
    input, select { outline: none; }
    button { cursor: pointer; border: none; background: none; font-family: inherit; color: inherit; }
    .card { background: var(--card); border-radius: 16px; padding: 16px; border: 1px solid var(--border); }
    .tag { display: inline-block; padding: 2px 8px; border-radius: 99px; font-size: 11px; font-weight: 600; }
    input[type=number], input[type=text], input[type=date], select {
      background: var(--bg); border: 1px solid var(--border); border-radius: 10px;
      color: var(--text); padding: 8px 12px; width: 100%; font-size: 14px; font-family: inherit;
    }
    input[type=date] { color-scheme: dark; }
    input:focus, select:focus { border-color: var(--accent); }
    .btn-primary { background: var(--accent); color: var(--bg); border-radius: 10px; padding: 10px 18px; font-weight: 700; font-size: 14px; transition: opacity 0.15s; font-family: inherit; }
    .btn-primary:active { opacity: 0.75; }
    .btn-ghost { border: 1px solid var(--border); border-radius: 10px; padding: 8px 14px; color: #999; font-size: 13px; font-family: inherit; }
    .btn-ghost:active { border-color: var(--accent); color: var(--accent); }
    .gap-col { display: flex; flex-direction: column; gap: 12px; }
    #app { display: none; }
    #loading { display: flex; height: 100vh; align-items: center; justify-content: center; color: var(--accent); font-size: 20px; }
  </style>
</head>
<body>
<div id="loading">ë¡œë”© ì¤‘...</div>
<div id="app">
  <!-- Header -->
  <div id="header" style="padding: 16px 20px 0; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; background:var(--bg); z-index:50; padding-bottom:8px;">
    <div>
      <div style="font-size:10px; color:var(--muted); letter-spacing:2px; text-transform:uppercase">Personal</div>
      <div style="font-size:20px; font-weight:700; color:var(--accent)">ë‹¤ì´ì–´íŠ¸ íŠ¸ë˜ì»¤</div>
    </div>
    <div style="text-align:right" id="header-right"></div>
  </div>

  <!-- Content -->
  <div id="content" style="padding: 12px 16px 0;"></div>

  <!-- Bottom Nav -->
  <nav style="position:fixed; bottom:0; left:50%; transform:translateX(-50%); width:100%; max-width:480px; background:var(--card); border-top:1px solid var(--border); display:flex; z-index:100;">
    <button class="nav-btn" data-tab="0" onclick="switchTab(0)" style="flex:1; padding:10px 0 12px; display:flex; flex-direction:column; align-items:center; gap:3px;">
      <span style="font-size:20px">ğŸ </span><span style="font-size:10px" class="nav-label">ëŒ€ì‹œë³´ë“œ</span>
    </button>
    <button class="nav-btn" data-tab="1" onclick="switchTab(1)" style="flex:1; padding:10px 0 12px; display:flex; flex-direction:column; align-items:center; gap:3px;">
      <span style="font-size:20px">ğŸ½ï¸</span><span style="font-size:10px" class="nav-label">ì‹ë‹¨</span>
    </button>
    <button class="nav-btn" data-tab="2" onclick="switchTab(2)" style="flex:1; padding:10px 0 12px; display:flex; flex-direction:column; align-items:center; gap:3px;">
      <span style="font-size:20px">ğŸ’ª</span><span style="font-size:10px" class="nav-label">ìš´ë™</span>
    </button>
    <button class="nav-btn" data-tab="3" onclick="switchTab(3)" style="flex:1; padding:10px 0 12px; display:flex; flex-direction:column; align-items:center; gap:3px;">
      <span style="font-size:20px">âš–ï¸</span><span style="font-size:10px" class="nav-label">ì²´ì¤‘</span>
    </button>
    <button class="nav-btn" data-tab="4" onclick="switchTab(4)" style="flex:1; padding:10px 0 12px; display:flex; flex-direction:column; align-items:center; gap:3px;">
      <span style="font-size:20px">ğŸ“Š</span><span style="font-size:10px" class="nav-label">í†µê³„</span>
    </button>
  </nav>
</div>

<script>
// ========= DATA =========
const FOOD_DB = [
  { name:"ê³µê¸°ë°¥", cal:300, carb:65, pro:5, fat:1 },
  { name:"ì‚¶ì€ ë‹¬ê±€", cal:78, carb:1, pro:6, fat:5 },
  { name:"ë‹­ê°€ìŠ´ì‚´ 100g", cal:165, carb:0, pro:31, fat:3.6 },
  { name:"ë°”ë‚˜ë‚˜", cal:89, carb:23, pro:1, fat:0.3 },
  { name:"ë‘ë¶€ 100g", cal:76, carb:2, pro:8, fat:4 },
  { name:"ìƒëŸ¬ë“œ(ê¸°ë³¸)", cal:50, carb:8, pro:2, fat:1 },
  { name:"ë¼ë©´", cal:500, carb:75, pro:10, fat:17 },
  { name:"ê¹€ë°¥ 1ì¤„", cal:340, carb:60, pro:10, fat:7 },
  { name:"ì˜¤íŠ¸ë°€ 100g", cal:389, carb:66, pro:17, fat:7 },
  { name:"ê·¸ë¦­ìš”ê±°íŠ¸", cal:100, carb:6, pro:10, fat:3 },
  { name:"ìš°ìœ  200ml", cal:130, carb:10, pro:7, fat:7 },
  { name:"ì•„ë©”ë¦¬ì¹´ë…¸", cal:10, carb:2, pro:0, fat:0 },
  { name:"ì‚¬ê³¼", cal:72, carb:19, pro:0.4, fat:0.2 },
  { name:"ê³ êµ¬ë§ˆ 100g", cal:86, carb:20, pro:1.6, fat:0.1 },
  { name:"í˜„ë¯¸ë°¥", cal:280, carb:60, pro:6, fat:2 },
  { name:"ëœì¥ì°Œê°œ", cal:120, carb:10, pro:8, fat:5 },
  { name:"ë¶ˆê³ ê¸° 100g", cal:200, carb:10, pro:20, fat:9 },
  { name:"ì œìœ¡ë³¶ìŒ 100g", cal:230, carb:8, pro:18, fat:14 },
  { name:"ë¹„ë¹”ë°¥", cal:550, carb:80, pro:18, fat:12 },
  { name:"ìˆœë‘ë¶€ì°Œê°œ", cal:150, carb:8, pro:12, fat:6 },
  { name:"ì•„ë³´ì¹´ë„", cal:160, carb:9, pro:2, fat:15 },
  { name:"ê²¬ê³¼ë¥˜ í•œì¤Œ", cal:180, carb:6, pro:5, fat:16 },
  { name:"ë‹¨ë°±ì§ˆì‰ì´í¬", cal:150, carb:10, pro:25, fat:3 },
];

const WORKOUT_DB = [
  { name:"ê±·ê¸° 30ë¶„", cal:150, type:"ìœ ì‚°ì†Œ" },
  { name:"ì¡°ê¹… 30ë¶„", cal:300, type:"ìœ ì‚°ì†Œ" },
  { name:"ëŸ¬ë‹ 30ë¶„", cal:400, type:"ìœ ì‚°ì†Œ" },
  { name:"ìì „ê±° 30ë¶„", cal:250, type:"ìœ ì‚°ì†Œ" },
  { name:"ìˆ˜ì˜ 30ë¶„", cal:350, type:"ìœ ì‚°ì†Œ" },
  { name:"ìŠ¤ì¿¼íŠ¸ 3ì„¸íŠ¸", cal:100, type:"ê·¼ë ¥" },
  { name:"í‘¸ì‰¬ì—… 3ì„¸íŠ¸", cal:80, type:"ê·¼ë ¥" },
  { name:"í”Œë­í¬ 3ì„¸íŠ¸", cal:50, type:"ê·¼ë ¥" },
  { name:"ì›¨ì´íŠ¸ íŠ¸ë ˆì´ë‹ 1ì‹œê°„", cal:300, type:"ê·¼ë ¥" },
  { name:"ìš”ê°€ 1ì‹œê°„", cal:200, type:"ìœ ì—°ì„±" },
  { name:"HIIT 20ë¶„", cal:300, type:"ìœ ì‚°ì†Œ" },
  { name:"í•„ë¼í…ŒìŠ¤ 1ì‹œê°„", cal:250, type:"ìœ ì—°ì„±" },
  { name:"ë“±ì‚° 1ì‹œê°„", cal:400, type:"ìœ ì‚°ì†Œ" },
  { name:"ì¤„ë„˜ê¸° 20ë¶„", cal:220, type:"ìœ ì‚°ì†Œ" },
];

// ========= STATE =========
let state = {
  tab: 0,
  weightLogs: [], mealLogs: [], workoutLogs: [],
  goal: { targetWeight: 65, dailyCal: 1800, startWeight: 75 },
  water: {},
  mealDate: todayStr(), mealType: "ì•„ì¹¨", showMealAdd: false, mealQuery: "",
  workoutDate: todayStr(), showWorkoutAdd: false, workoutQuery: "",
  weightDate: todayStr(),
  showGoalEdit: false,
};

function todayStr() { return new Date().toISOString().split("T")[0]; }
function formatDate(d) {
  return new Date(d).toLocaleDateString("ko-KR", { month:"short", day:"numeric", weekday:"short" });
}
function ls(key, fallback) {
  try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; } catch { return fallback; }
}
function ss(key, val) { try { localStorage.setItem(key, JSON.stringify(val)); } catch {} }

function loadState() {
  state.weightLogs = ls("dw", []);
  state.mealLogs = ls("dm", []);
  state.workoutLogs = ls("dwo", []);
  state.goal = ls("dg", { targetWeight: 65, dailyCal: 1800, startWeight: 75 });
  state.water = ls("dwat", {});
}
function saveWeights() { ss("dw", state.weightLogs); }
function saveMeals() { ss("dm", state.mealLogs); }
function saveWorkouts() { ss("dwo", state.workoutLogs); }
function saveGoal() { ss("dg", state.goal); }
function saveWater() { ss("dwat", state.water); }

// ========= RENDER =========
function render() {
  updateHeader();
  updateNavHighlight();
  const content = document.getElementById("content");
  if (state.tab === 0) content.innerHTML = renderDashboard();
  else if (state.tab === 1) content.innerHTML = renderMealTab();
  else if (state.tab === 2) content.innerHTML = renderWorkoutTab();
  else if (state.tab === 3) content.innerHTML = renderWeightTab();
  else if (state.tab === 4) content.innerHTML = renderStatsTab();
}

function updateHeader() {
  const latestWeight = state.weightLogs.length ? state.weightLogs[state.weightLogs.length - 1].weight : null;
  const dateStr = new Date().toLocaleDateString("ko-KR", { month:"long", day:"numeric", weekday:"long" });
  document.getElementById("header-right").innerHTML = `
    <div style="font-size:11px;color:var(--muted)">${dateStr}</div>
    ${latestWeight ? `<div style="font-size:16px;font-weight:600;color:var(--accent)">${latestWeight}kg</div>` : ""}
  `;
}

function updateNavHighlight() {
  document.querySelectorAll(".nav-label").forEach((el, i) => {
    el.style.color = i === state.tab ? "var(--accent)" : "var(--muted)";
    el.style.fontWeight = i === state.tab ? "700" : "400";
  });
}

function switchTab(t) { state.tab = t; render(); }

// ========= DASHBOARD =========
function renderDashboard() {
  const t = todayStr();
  const todayMeals = state.mealLogs.filter(m => m.date === t);
  const todayWorkouts = state.workoutLogs.filter(w => w.date === t);
  const calIn = todayMeals.reduce((s, m) => s + m.cal, 0);
  const calOut = todayWorkouts.reduce((s, w) => s + w.cal, 0);
  const netCal = calIn - calOut;
  const remaining = Math.max(state.goal.dailyCal - netCal, 0);
  const pct = Math.min(calIn / state.goal.dailyCal, 1);
  const todayWater = state.water[t] || 0;
  const latestWeight = state.weightLogs.length ? state.weightLogs[state.weightLogs.length - 1].weight : null;
  const bmi = latestWeight ? (latestWeight / (1.7 * 1.7)).toFixed(1) : null;

  const circ = 2 * Math.PI * 48;
  const offset = circ * (1 - pct);

  const weightToTarget = latestWeight ? Math.abs(latestWeight - state.goal.targetWeight).toFixed(1) : "?";
  const weightDiff = latestWeight ? latestWeight - state.goal.targetWeight : 0;

  const waterGlasses = Array.from({length:8}).map((_, i) => {
    const filled = i < Math.floor(todayWater / 250);
    const partial = !filled && i === Math.floor(todayWater / 250) && todayWater % 250 > 0;
    const bg = filled ? "var(--accent)" : partial ? "#4a6a1a" : "var(--border)";
    return `<div style="flex:1;height:28px;border-radius:6px;background:${bg};transition:background 0.2s"></div>`;
  }).join("");

  return `
  <div class="gap-col">
    <!-- Calorie Ring -->
    <div class="card" style="display:flex;align-items:center;gap:16px;">
      <svg width="112" height="112" viewBox="0 0 112 112">
        <circle fill="none" stroke="var(--border)" cx="56" cy="56" r="48" stroke-width="10"/>
        <circle fill="none" stroke="var(--accent)" stroke-linecap="round" cx="56" cy="56" r="48" stroke-width="10"
          stroke-dasharray="${circ.toFixed(1)}" stroke-dashoffset="${offset.toFixed(1)}"
          style="transform-origin:56px 56px;transform:rotate(-90deg)"/>
        <text x="56" y="50" text-anchor="middle" fill="var(--text)" font-size="16" font-weight="700" font-family="Noto Sans KR">${calIn}</text>
        <text x="56" y="66" text-anchor="middle" fill="var(--muted)" font-size="11" font-family="Noto Sans KR">kcal ì„­ì·¨</text>
      </svg>
      <div style="flex:1">
        <div style="margin-bottom:10px">
          <div style="font-size:11px;color:var(--muted);margin-bottom:2px">ëª©í‘œ ì¹¼ë¡œë¦¬</div>
          <div style="font-size:22px;font-weight:700;color:var(--accent)">${state.goal.dailyCal} kcal</div>
        </div>
        <div style="display:flex;gap:12px">
          <div><div style="font-size:10px;color:var(--muted)">ì†Œëª¨</div><div style="font-size:15px;font-weight:600;color:var(--green)">-${calOut}</div></div>
          <div><div style="font-size:10px;color:var(--muted)">ìˆœì¹¼ë¡œë¦¬</div><div style="font-size:15px;font-weight:600;color:${netCal > state.goal.dailyCal ? "var(--red)" : "var(--text)"}">${netCal}</div></div>
          <div><div style="font-size:10px;color:var(--muted)">ë‚¨ì€</div><div style="font-size:15px;font-weight:600;color:var(--accent)">${remaining}</div></div>
        </div>
      </div>
    </div>

    <!-- Water -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div style="font-weight:600">ğŸ’§ ë¬¼ ì„­ì·¨</div>
        <div style="font-size:13px;color:var(--accent)">${todayWater}ml / 2000ml</div>
      </div>
      <div style="display:flex;gap:4px;margin-bottom:10px">${waterGlasses}</div>
      <div style="display:flex;gap:8px">
        <button class="btn-ghost" onclick="adjustWater(-250)" style="flex:1">-250ml</button>
        <button class="btn-primary" onclick="adjustWater(250)" style="flex:2">+250ml ì¶”ê°€</button>
      </div>
    </div>

    <!-- Quick Stats -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div class="card" style="text-align:center"><div style="font-size:24px">ğŸ‹ï¸</div><div style="font-size:20px;font-weight:700;color:var(--accent)">${todayWorkouts.length}</div><div style="font-size:11px;color:var(--muted)">ì˜¤ëŠ˜ ìš´ë™</div></div>
      <div class="card" style="text-align:center"><div style="font-size:24px">ğŸ½ï¸</div><div style="font-size:20px;font-weight:700;color:var(--accent)">${todayMeals.length}</div><div style="font-size:11px;color:var(--muted)">ì˜¤ëŠ˜ ì‹ì‚¬</div></div>
      ${latestWeight ? `<div class="card" style="text-align:center"><div style="font-size:24px">âš–ï¸</div><div style="font-size:20px;font-weight:700;color:var(--accent)">${latestWeight}kg</div><div style="font-size:11px;color:var(--muted)">í˜„ì¬ ì²´ì¤‘</div></div>` : ""}
      ${bmi ? `<div class="card" style="text-align:center"><div style="font-size:24px">ğŸ“</div><div style="font-size:20px;font-weight:700;color:var(--accent)">${bmi}</div><div style="font-size:11px;color:var(--muted)">BMI</div></div>` : ""}
    </div>

    <!-- Goal -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:${state.showGoalEdit ? "12px" : "0"}">
        <div style="font-weight:600">ğŸ¯ ëª©í‘œ ì„¤ì •</div>
        <button class="btn-ghost" style="font-size:12px;padding:4px 10px" onclick="toggleGoalEdit()">${state.showGoalEdit ? "ì ‘ê¸°" : "ìˆ˜ì •"}</button>
      </div>
      ${state.showGoalEdit ? `
        <div style="display:flex;flex-direction:column;gap:10px">
          <div><div style="font-size:12px;color:var(--muted);margin-bottom:4px">ì‹œì‘ ì²´ì¤‘ (kg)</div>
            <input type="number" step="0.1" value="${state.goal.startWeight}" onchange="updateGoalField('startWeight', parseFloat(this.value))"></div>
          <div><div style="font-size:12px;color:var(--muted);margin-bottom:4px">ëª©í‘œ ì²´ì¤‘ (kg)</div>
            <input type="number" step="0.1" value="${state.goal.targetWeight}" onchange="updateGoalField('targetWeight', parseFloat(this.value))"></div>
          <div><div style="font-size:12px;color:var(--muted);margin-bottom:4px">ì¼ì¼ ì¹¼ë¡œë¦¬ ëª©í‘œ (kcal)</div>
            <input type="number" value="${state.goal.dailyCal}" onchange="updateGoalField('dailyCal', parseInt(this.value))"></div>
          <button class="btn-primary" onclick="saveGoalEdit()">ì €ì¥</button>
        </div>
      ` : `
        <div style="display:flex;gap:16px;margin-top:8px;flex-wrap:wrap">
          <div><span style="font-size:11px;color:var(--muted)">ì‹œì‘ </span><span style="color:var(--accent);font-weight:600">${state.goal.startWeight}kg</span></div>
          <div>â†’</div>
          <div><span style="font-size:11px;color:var(--muted)">ëª©í‘œ </span><span style="color:var(--accent);font-weight:600">${state.goal.targetWeight}kg</span></div>
          <div style="margin-left:auto"><span style="font-size:11px;color:var(--muted)">ì”ì—¬ </span><span style="color:${weightDiff > 0 ? "var(--red)" : "var(--green)"};font-weight:600">${weightToTarget}kg</span></div>
        </div>
      `}
    </div>
  </div>`;
}

// ========= MEAL TAB =========
function renderMealTab() {
  const dayMeals = state.mealLogs.filter(m => m.date === state.mealDate);
  const totalCal = dayMeals.reduce((s, m) => s + m.cal, 0);
  const carb = dayMeals.reduce((s, m) => s + (m.carb||0), 0);
  const pro = dayMeals.reduce((s, m) => s + (m.pro||0), 0);
  const fat = dayMeals.reduce((s, m) => s + (m.fat||0), 0);

  const filteredFoods = state.mealQuery
    ? FOOD_DB.filter(f => f.name.includes(state.mealQuery))
    : [];

  const groups = ["ì•„ì¹¨","ì ì‹¬","ì €ë…","ê°„ì‹"].map(type => ({
    type, meals: dayMeals.filter(m => m.mealType === type)
  })).filter(g => g.meals.length > 0);

  const mealItems = groups.map(g => `
    <div class="card">
      <div style="font-size:13px;font-weight:700;color:var(--accent);margin-bottom:8px">${g.type}</div>
      ${g.meals.map(m => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #1f1f2e">
          <div>
            <div style="font-size:14px">${m.name}</div>
            ${m.pro > 0 ? `<div style="font-size:11px;color:var(--muted)">íƒ„${m.carb}g Â· ë‹¨${m.pro}g Â· ì§€${m.fat}g</div>` : ""}
          </div>
          <div style="display:flex;align-items:center;gap:10px">
            <span style="font-weight:600;color:var(--accent)">${m.cal}</span>
            <button onclick="deleteMeal(${m.id})" style="color:var(--muted);font-size:18px;line-height:1">Ã—</button>
          </div>
        </div>
      `).join("")}
    </div>
  `).join("");

  const searchResults = state.mealQuery ? `
    <div style="max-height:200px;overflow-y:auto;display:flex;flex-direction:column;gap:6px">
      ${filteredFoods.length === 0 ? `<div style="color:var(--muted);font-size:13px;text-align:center;padding:10px">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>` : ""}
      ${filteredFoods.map((f, i) => `
        <button onclick="addFoodFromDB(${i})" style="background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:8px 12px;display:flex;justify-content:space-between;align-items:center;width:100%;color:var(--text)">
          <span style="font-size:14px">${f.name}</span>
          <span style="color:var(--accent);font-size:13px;font-weight:600">${f.cal} kcal</span>
        </button>
      `).join("")}
    </div>
  ` : "";

  return `
  <div class="gap-col">
    <div style="display:flex;gap:8px;align-items:center">
      <input type="date" value="${state.mealDate}" onchange="state.mealDate=this.value;render()" style="flex:1">
      <button class="btn-primary" onclick="state.showMealAdd=!state.showMealAdd;render()">+ ì¶”ê°€</button>
    </div>

    <div class="card" style="display:flex;justify-content:space-around;text-align:center">
      <div><div style="font-size:18px;font-weight:700;color:var(--accent)">${totalCal}</div><div style="font-size:10px;color:var(--muted)">kcal</div></div>
      <div style="width:1px;background:var(--border)"></div>
      <div><div style="font-size:15px;font-weight:600;color:var(--blue)">${carb}g</div><div style="font-size:10px;color:var(--muted)">íƒ„ìˆ˜í™”ë¬¼</div></div>
      <div><div style="font-size:15px;font-weight:600;color:var(--green)">${pro}g</div><div style="font-size:10px;color:var(--muted)">ë‹¨ë°±ì§ˆ</div></div>
      <div><div style="font-size:15px;font-weight:600;color:var(--yellow)">${fat}g</div><div style="font-size:10px;color:var(--muted)">ì§€ë°©</div></div>
    </div>

    ${state.showMealAdd ? `
      <div class="card" style="display:flex;flex-direction:column;gap:10px">
        <select onchange="state.mealType=this.value">
          ${["ì•„ì¹¨","ì ì‹¬","ì €ë…","ê°„ì‹"].map(t => `<option ${t===state.mealType?"selected":""}>${t}</option>`).join("")}
        </select>

        <!-- AI ë¶„ì„ ì˜ì—­ -->
        <div style="background:var(--bg);border:1px solid var(--accent)33;border-radius:12px;padding:12px">
          <div style="font-size:12px;color:var(--accent);font-weight:600;margin-bottom:8px">ğŸ¤– AI ì˜ì–‘ ìë™ ë¶„ì„</div>
          <div style="display:flex;gap:8px">
            <input type="text" placeholder="ì˜ˆ: ì‚¼ê²¹ì‚´ 200g, ë¼ë©´ 1ê°œ, ì¹˜í‚¨ ë°˜ë§ˆë¦¬..." id="ai-food-input" style="flex:1"
              onkeydown="if(event.key==='Enter')analyzeNutrition()">
            <button class="btn-primary" onclick="analyzeNutrition()" id="ai-btn" style="white-space:nowrap;padding:8px 14px">ë¶„ì„</button>
          </div>
          <div id="ai-result" style="margin-top:0"></div>
        </div>

        <!-- DB ê²€ìƒ‰ -->
        <div style="border-top:1px solid var(--border);padding-top:10px">
          <div style="font-size:12px;color:var(--muted);margin-bottom:8px">ìì£¼ ì“°ëŠ” ìŒì‹ ê²€ìƒ‰</div>
          <input type="text" placeholder="ìŒì‹ ê²€ìƒ‰..." value="${state.mealQuery}" oninput="state.mealQuery=this.value;render()" />
          ${searchResults}
        </div>

        <!-- ìˆ˜ë™ ì…ë ¥ -->
        <div style="border-top:1px solid var(--border);padding-top:10px">
          <div style="font-size:12px;color:var(--muted);margin-bottom:8px">ì§ì ‘ ì…ë ¥</div>
          <div style="display:flex;flex-direction:column;gap:6px">
            <input type="text" placeholder="ìŒì‹ëª…" id="c-name">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
              <input type="number" placeholder="ì¹¼ë¡œë¦¬(kcal)" id="c-cal">
              <input type="number" placeholder="íƒ„ìˆ˜í™”ë¬¼(g)" id="c-carb">
              <input type="number" placeholder="ë‹¨ë°±ì§ˆ(g)" id="c-pro">
              <input type="number" placeholder="ì§€ë°©(g)" id="c-fat">
            </div>
            <button class="btn-primary" onclick="addCustomFood()">ì§ì ‘ ì¶”ê°€</button>
          </div>
        </div>
      </div>
    ` : ""}

    ${mealItems}
    ${dayMeals.length === 0 && !state.showMealAdd ? `
      <div style="text-align:center;color:var(--muted);padding:40px">
        <div style="font-size:40px;margin-bottom:10px">ğŸ½ï¸</div>
        <div>ì•„ì§ ê¸°ë¡ëœ ì‹ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤</div>
      </div>
    ` : ""}
  </div>`;
}

// ========= WORKOUT TAB =========
function renderWorkoutTab() {
  const dayWorkouts = state.workoutLogs.filter(w => w.date === state.workoutDate);
  const totalCal = dayWorkouts.reduce((s, w) => s + w.cal, 0);
  const typeColor = { "ìœ ì‚°ì†Œ":"var(--blue)", "ê·¼ë ¥":"var(--red)", "ìœ ì—°ì„±":"var(--purple)" };

  const filteredWorkouts = state.workoutQuery
    ? WORKOUT_DB.filter(w => w.name.includes(state.workoutQuery) || w.type.includes(state.workoutQuery))
    : [];

  const searchResults = state.workoutQuery ? `
    <div style="max-height:220px;overflow-y:auto;display:flex;flex-direction:column;gap:6px">
      ${filteredWorkouts.map((w, i) => `
        <button onclick="addWorkoutFromDB(${WORKOUT_DB.indexOf(w)})" style="background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:8px 12px;display:flex;justify-content:space-between;align-items:center;width:100%;color:var(--text)">
          <div style="text-align:left">
            <div style="font-size:14px">${w.name}</div>
            <span class="tag" style="background:${typeColor[w.type]}22;color:${typeColor[w.type]}">${w.type}</span>
          </div>
          <span style="color:var(--green);font-weight:600">-${w.cal} kcal</span>
        </button>
      `).join("")}
    </div>
  ` : "";

  return `
  <div class="gap-col">
    <div style="display:flex;gap:8px;align-items:center">
      <input type="date" value="${state.workoutDate}" onchange="state.workoutDate=this.value;render()" style="flex:1">
      <button class="btn-primary" onclick="state.showWorkoutAdd=!state.showWorkoutAdd;render()">+ ì¶”ê°€</button>
    </div>

    ${totalCal > 0 ? `
      <div class="card" style="text-align:center">
        <div style="font-size:28px;font-weight:700;color:var(--green)">ğŸ”¥ ${totalCal} kcal</div>
        <div style="font-size:11px;color:var(--muted)">ì˜¤ëŠ˜ ì†Œëª¨ ì¹¼ë¡œë¦¬</div>
      </div>
    ` : ""}

    ${state.showWorkoutAdd ? `
      <div class="card" style="display:flex;flex-direction:column;gap:10px">
        <input type="text" placeholder="ìš´ë™ ê²€ìƒ‰ (ì˜ˆ: ì¡°ê¹…, ê·¼ë ¥)" value="${state.workoutQuery}" oninput="state.workoutQuery=this.value;render()">
        ${searchResults}
        <div style="border-top:1px solid var(--border);padding-top:10px">
          <div style="font-size:12px;color:var(--muted);margin-bottom:8px">ì§ì ‘ ì…ë ¥</div>
          <div style="display:flex;flex-direction:column;gap:6px">
            <input type="text" placeholder="ìš´ë™ëª…" id="wo-name">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
              <input type="number" placeholder="ì‹œê°„(ë¶„)" id="wo-dur">
              <input type="number" placeholder="ì†Œëª¨ ì¹¼ë¡œë¦¬" id="wo-cal">
            </div>
            <select id="wo-type">
              <option>ìœ ì‚°ì†Œ</option><option>ê·¼ë ¥</option><option>ìœ ì—°ì„±</option>
            </select>
            <button class="btn-primary" onclick="addCustomWorkout()">ì¶”ê°€</button>
          </div>
        </div>
      </div>
    ` : ""}

    ${dayWorkouts.map(w => `
      <div class="card" style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-size:14px;font-weight:600">${w.name}</div>
          <span class="tag" style="background:${(typeColor[w.type]||"var(--accent)")}22;color:${typeColor[w.type]||"var(--accent)"}">${w.type}</span>
        </div>
        <div style="display:flex;align-items:center;gap:10px">
          <div style="text-align:right"><div style="color:var(--green);font-weight:700">-${w.cal}</div><div style="font-size:10px;color:var(--muted)">kcal</div></div>
          <button onclick="deleteWorkout(${w.id})" style="color:var(--muted);font-size:18px">Ã—</button>
        </div>
      </div>
    `).join("")}

    ${dayWorkouts.length === 0 && !state.showWorkoutAdd ? `
      <div style="text-align:center;color:var(--muted);padding:40px">
        <div style="font-size:40px;margin-bottom:10px">ğŸ’ª</div>
        <div>ì˜¤ëŠ˜ ìš´ë™ ê¸°ë¡ì„ ì¶”ê°€í•´ë³´ì„¸ìš”</div>
      </div>
    ` : ""}
  </div>`;
}

// ========= WEIGHT TAB =========
function renderWeightTab() {
  const latest = state.weightLogs.length ? state.weightLogs[state.weightLogs.length - 1].weight : null;
  const first = state.weightLogs.length ? state.weightLogs[0].weight : null;
  const change = first && latest ? (latest - first).toFixed(1) : null;

  const chartSvg = state.weightLogs.length > 1 ? renderWeightChartSVG() : "";

  return `
  <div class="gap-col">
    <div class="card" style="display:flex;flex-direction:column;gap:10px">
      <div style="font-size:13px;font-weight:600">ì²´ì¤‘ ê¸°ë¡</div>
      <input type="date" value="${state.weightDate}" onchange="state.weightDate=this.value">
      <div style="position:relative">
        <input type="number" placeholder="ì²´ì¤‘ ì…ë ¥" step="0.1" id="w-val" style="padding-right:40px">
        <span style="position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:13px">kg</span>
      </div>
      <input type="text" placeholder="ë©”ëª¨ (ì„ íƒ)" id="w-note">
      <button class="btn-primary" onclick="addWeight()">ê¸°ë¡í•˜ê¸°</button>
    </div>

    ${latest ? `
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
        <div class="card" style="text-align:center"><div style="font-size:16px;font-weight:700">${latest}kg</div><div style="font-size:10px;color:var(--muted)">í˜„ì¬</div></div>
        <div class="card" style="text-align:center"><div style="font-size:16px;font-weight:700;color:${state.goal.targetWeight < latest ? "var(--red)" : "var(--green)"}">${state.goal.targetWeight}kg</div><div style="font-size:10px;color:var(--muted)">ëª©í‘œ</div></div>
        <div class="card" style="text-align:center"><div style="font-size:16px;font-weight:700;color:${change > 0 ? "var(--red)" : "var(--green)"}">${change > 0 ? "+" : ""}${change}kg</div><div style="font-size:10px;color:var(--muted)">ì´ ë³€í™”</div></div>
      </div>
    ` : ""}

    ${chartSvg ? `<div class="card"><div style="font-size:13px;font-weight:600;margin-bottom:8px">ìµœê·¼ ì²´ì¤‘ ì¶”ì´</div>${chartSvg}</div>` : ""}

    <div class="card">
      <div style="font-size:13px;font-weight:600;margin-bottom:10px">ê¸°ë¡ ë‚´ì—­</div>
      ${[...state.weightLogs].reverse().slice(0, 20).map(w => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #1f1f2e">
          <div>
            <div style="font-size:13px">${formatDate(w.date)}</div>
            ${w.note ? `<div style="font-size:11px;color:var(--muted)">${w.note}</div>` : ""}
          </div>
          <div style="display:flex;align-items:center;gap:10px">
            <span style="font-weight:600;color:var(--accent)">${w.weight}kg</span>
            <button onclick="deleteWeight('${w.date}')" style="color:var(--muted);font-size:18px">Ã—</button>
          </div>
        </div>
      `).join("")}
      ${state.weightLogs.length === 0 ? `<div style="text-align:center;color:var(--muted);padding:20px">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>` : ""}
    </div>
  </div>`;
}

function renderWeightChartSVG() {
  const logs = state.weightLogs.slice(-14);
  const weights = logs.map(l => l.weight);
  const min = Math.min(...weights) - 1;
  const max = Math.max(...weights) + 1;
  const W = 300, H = 90;
  const toY = w => H - ((w - min) / (max - min)) * H;
  const toX = i => logs.length > 1 ? (i / (logs.length - 1)) * W : W / 2;

  const path = logs.map((l, i) => `${i === 0 ? "M" : "L"} ${toX(i).toFixed(1)} ${toY(l.weight).toFixed(1)}`).join(" ");
  const goalY = toY(state.goal.targetWeight);
  const dots = logs.map((l, i) => `<circle cx="${toX(i).toFixed(1)}" cy="${toY(l.weight).toFixed(1)}" r="3" fill="var(--accent)"/>`).join("");

  return `
    <svg viewBox="0 0 ${W} ${H}" style="width:100%;overflow:visible">
      ${goalY >= 0 && goalY <= H ? `
        <line x1="0" y1="${goalY.toFixed(1)}" x2="${W}" y2="${goalY.toFixed(1)}" stroke="#a3e63555" stroke-dasharray="4 4" stroke-width="1"/>
        <text x="${W-2}" y="${(goalY-4).toFixed(1)}" text-anchor="end" fill="var(--accent)" font-size="9" font-family="Noto Sans KR">ëª©í‘œ</text>
      ` : ""}
      <path d="${path}" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      ${dots}
    </svg>`;
}

// ========= STATS TAB =========
function renderStatsTab() {
  const days7 = Array.from({length:7}).map((_, i) => {
    const d = new Date(); d.setDate(d.getDate() - (6 - i));
    return d.toISOString().split("T")[0];
  });

  const weekData = days7.map(d => ({
    date: d,
    label: new Date(d).toLocaleDateString("ko-KR", {weekday:"short"}),
    cal: state.mealLogs.filter(m => m.date === d).reduce((s, m) => s + m.cal, 0),
    burned: state.workoutLogs.filter(w => w.date === d).reduce((s, w) => s + w.cal, 0),
  }));

  const maxCal = Math.max(...weekData.map(w => w.cal), state.goal.dailyCal, 100);

  const totalWorkouts = state.workoutLogs.length;
  const dateCals = {};
  state.mealLogs.forEach(m => { dateCals[m.date] = (dateCals[m.date] || 0) + m.cal; });
  const dateKeys = Object.keys(dateCals);
  const avgCal = dateKeys.length > 0 ? Math.round(dateKeys.reduce((s, k) => s + dateCals[k], 0) / dateKeys.length) : 0;

  // Streak
  let streak = 0;
  const dCheck = new Date();
  while (true) {
    const key = dCheck.toISOString().split("T")[0];
    const hasData = state.weightLogs.some(w => w.date === key) || state.mealLogs.some(m => m.date === key) || state.workoutLogs.some(w => w.date === key);
    if (hasData) { streak++; dCheck.setDate(dCheck.getDate() - 1); } else break;
  }

  const workoutTypes = {};
  state.workoutLogs.forEach(w => { workoutTypes[w.type] = (workoutTypes[w.type]||0) + 1; });

  const bars = weekData.map(d => {
    const calH = maxCal > 0 ? (d.cal / maxCal) * 100 : 0;
    const isToday = d.date === todayStr();
    return `
      <div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:2px">
        <div style="width:100%;height:100px;position:relative;display:flex;align-items:flex-end;gap:2px">
          <div style="position:absolute;top:${100-(state.goal.dailyCal/maxCal*100)}%;left:0;right:0;height:1px;background:#a3e63555;z-index:1"></div>
          <div style="flex:1;height:${calH.toFixed(1)}%;background:${isToday?"var(--accent)":"#3a4a20"};border-radius:3px 3px 0 0;transition:height 0.3s;min-height:${d.cal>0?"3px":"0"}"></div>
        </div>
        <div style="font-size:9px;color:${isToday?"var(--accent)":"var(--muted)"}">${d.label}</div>
      </div>`;
  }).join("");

  const typeColors = { "ìœ ì‚°ì†Œ":"var(--blue)", "ê·¼ë ¥":"var(--red)", "ìœ ì—°ì„±":"var(--purple)" };
  const typeRows = Object.entries(workoutTypes).map(([type, count]) => {
    const pct = Math.round((count/totalWorkouts)*100);
    return `
      <div style="margin-bottom:8px">
        <div style="display:flex;justify-content:space-between;margin-bottom:4px">
          <span style="font-size:13px;color:${typeColors[type]||"var(--accent)"}">${type}</span>
          <span style="font-size:12px;color:var(--muted)">${count}íšŒ (${pct}%)</span>
        </div>
        <div style="background:var(--border);border-radius:99px;height:6px">
          <div style="width:${pct}%;height:100%;background:${typeColors[type]||"var(--accent)"};border-radius:99px"></div>
        </div>
      </div>`;
  }).join("");

  const latest = state.weightLogs.length ? state.weightLogs[state.weightLogs.length-1].weight : null;
  const wFirst = state.weightLogs.length ? state.weightLogs[0].weight : null;

  return `
  <div class="gap-col">
    <div class="card" style="text-align:center;padding:24px">
      <div style="font-size:40px">ğŸ”¥</div>
      <div style="font-size:36px;font-weight:700;color:var(--accent)">${streak}ì¼</div>
      <div style="color:var(--muted);font-size:13px">ì—°ì† ê¸°ë¡ ì¤‘</div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div class="card" style="text-align:center"><div style="font-size:22px;font-weight:700;color:var(--accent)">${avgCal}</div><div style="font-size:11px;color:var(--muted)">í‰ê·  ì¼ì¼ ì¹¼ë¡œë¦¬</div></div>
      <div class="card" style="text-align:center"><div style="font-size:22px;font-weight:700;color:var(--green)">${totalWorkouts}</div><div style="font-size:11px;color:var(--muted)">ì´ ìš´ë™ íšŸìˆ˜</div></div>
    </div>

    <div class="card">
      <div style="font-size:13px;font-weight:600;margin-bottom:12px">ì£¼ê°„ ì¹¼ë¡œë¦¬ í˜„í™©</div>
      <div style="display:flex;gap:6px;align-items:flex-end;height:100px">${bars}</div>
      <div style="display:flex;gap:12px;margin-top:8px">
        <div style="display:flex;align-items:center;gap:4px"><div style="width:10px;height:10px;border-radius:2px;background:var(--accent)"></div><span style="font-size:10px;color:var(--muted)">ì„­ì·¨</span></div>
        <div style="display:flex;align-items:center;gap:4px"><div style="width:10px;height:1px;background:#a3e63555"></div><span style="font-size:10px;color:var(--muted)">ëª©í‘œ</span></div>
      </div>
    </div>

    ${totalWorkouts > 0 ? `
      <div class="card">
        <div style="font-size:13px;font-weight:600;margin-bottom:10px">ìš´ë™ ìœ í˜• ë¶„í¬</div>
        ${typeRows}
      </div>
    ` : ""}

    ${state.weightLogs.length >= 2 ? `
      <div class="card">
        <div style="font-size:13px;font-weight:600;margin-bottom:10px">ì²´ì¤‘ ë³€í™” ìš”ì•½</div>
        <div style="display:flex;justify-content:space-around;text-align:center">
          <div><div style="font-size:16px;font-weight:700">${wFirst}kg</div><div style="font-size:10px;color:var(--muted)">ì‹œì‘</div></div>
          <div><div style="font-size:28px">${latest - wFirst <= 0 ? "ğŸ“‰" : "ğŸ“ˆ"}</div></div>
          <div><div style="font-size:16px;font-weight:700;color:var(--accent)">${latest}kg</div><div style="font-size:10px;color:var(--muted)">í˜„ì¬</div></div>
          <div><div style="font-size:16px;font-weight:700;color:var(--accent)">${state.goal.targetWeight}kg</div><div style="font-size:10px;color:var(--muted)">ëª©í‘œ</div></div>
        </div>
        <div style="margin-top:12px;padding:8px 12px;background:var(--bg);border-radius:10px">
          <div style="font-size:12px;color:var(--muted)">ëª©í‘œê¹Œì§€</div>
          <div style="font-size:16px;font-weight:700;color:var(--accent)">${Math.abs(latest - state.goal.targetWeight).toFixed(1)}kg ë‚¨ìŒ</div>
        </div>
      </div>
    ` : ""}
  </div>`;
}

// ========= ACTIONS =========
function adjustWater(delta) {
  const t = todayStr();
  const cur = state.water[t] || 0;
  state.water[t] = Math.max(0, cur + delta);
  saveWater(); render();
}

function toggleGoalEdit() { state.showGoalEdit = !state.showGoalEdit; render(); }

function updateGoalField(field, val) { state.goal[field] = val; }

function saveGoalEdit() { saveGoal(); state.showGoalEdit = false; render(); }

function addFoodFromDB(idx) {
  const f = FOOD_DB[idx];
  state.mealLogs.push({ id: Date.now(), date: state.mealDate, mealType: state.mealType, ...f });
  saveMeals(); state.showMealAdd = false; state.mealQuery = ""; render();
}

function addCustomFood() {
  const name = document.getElementById("c-name")?.value;
  const cal = parseInt(document.getElementById("c-cal")?.value);
  if (!name || !cal) return;
  const carb = parseInt(document.getElementById("c-carb")?.value) || 0;
  const pro = parseInt(document.getElementById("c-pro")?.value) || 0;
  const fat = parseInt(document.getElementById("c-fat")?.value) || 0;
  state.mealLogs.push({ id: Date.now(), date: state.mealDate, mealType: state.mealType, name, cal, carb, pro, fat });
  saveMeals(); state.showMealAdd = false; state.mealQuery = ""; render();
}

function deleteMeal(id) {
  state.mealLogs = state.mealLogs.filter(m => m.id !== id);
  saveMeals(); render();
}

function addWorkoutFromDB(idx) {
  const w = WORKOUT_DB[idx];
  state.workoutLogs.push({ id: Date.now(), date: state.workoutDate, ...w });
  saveWorkouts(); state.showWorkoutAdd = false; state.workoutQuery = ""; render();
}

function addCustomWorkout() {
  const name = document.getElementById("wo-name")?.value;
  const cal = parseInt(document.getElementById("wo-cal")?.value);
  if (!name || !cal) return;
  const dur = document.getElementById("wo-dur")?.value;
  const type = document.getElementById("wo-type")?.value || "ìœ ì‚°ì†Œ";
  state.workoutLogs.push({ id: Date.now(), date: state.workoutDate, name: name + (dur ? ` ${dur}ë¶„` : ""), cal, type });
  saveWorkouts(); state.showWorkoutAdd = false; state.workoutQuery = ""; render();
}

function deleteWorkout(id) {
  state.workoutLogs = state.workoutLogs.filter(w => w.id !== id);
  saveWorkouts(); render();
}

function addWeight() {
  const val = parseFloat(document.getElementById("w-val")?.value);
  const note = document.getElementById("w-note")?.value || "";
  if (!val) return;
  const existing = state.weightLogs.findIndex(w => w.date === state.weightDate);
  if (existing >= 0) {
    state.weightLogs[existing] = { ...state.weightLogs[existing], weight: val, note };
  } else {
    state.weightLogs.push({ date: state.weightDate, weight: val, note });
    state.weightLogs.sort((a, b) => a.date.localeCompare(b.date));
  }
  saveWeights(); render();
}

function deleteWeight(date) {
  state.weightLogs = state.weightLogs.filter(w => w.date !== date);
  saveWeights(); render();
}

// ========= AI NUTRITION ANALYSIS =========
async function analyzeNutrition() {
  const input = document.getElementById("ai-food-input");
  const btn = document.getElementById("ai-btn");
  const resultDiv = document.getElementById("ai-result");
  if (!input || !input.value.trim()) return;

  const foodText = input.value.trim();
  btn.disabled = true;
  btn.textContent = "ë¶„ì„ ì¤‘...";
  resultDiv.style.marginTop = "10px";
  resultDiv.innerHTML = `
    <div style="display:flex;align-items:center;gap:8px;color:var(--muted);font-size:13px;padding:8px 0">
      <span style="display:inline-block;animation:spin 1s linear infinite">â³</span> AIê°€ ì˜ì–‘ì •ë³´ë¥¼ ë¶„ì„ ì¤‘...
    </div>
    <style>@keyframes spin{to{transform:rotate(360deg)}}</style>
  `;

  try {
    const response = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 1000,
        system: `ë‹¹ì‹ ì€ ì˜ì–‘ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì‚¬ìš©ìê°€ ì…ë ¥í•œ ìŒì‹ì˜ ì˜ì–‘ì •ë³´ë¥¼ ë¶„ì„í•´ì„œ ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”. ë‹¤ë¥¸ í…ìŠ¤íŠ¸ëŠ” ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.
{"items":[{"name":"ìŒì‹ëª…","amount":"ë¶„ëŸ‰ì„¤ëª…","cal":ìˆ«ì,"carb":ìˆ«ì,"pro":ìˆ«ì,"fat":ìˆ«ì}],"total":{"cal":ìˆ«ì,"carb":ìˆ«ì,"pro":ìˆ«ì,"fat":ìˆ«ì}}
ê·œì¹™: cal=ì¹¼ë¡œë¦¬(kcal), carb=íƒ„ìˆ˜í™”ë¬¼(g), pro=ë‹¨ë°±ì§ˆ(g), fat=ì§€ë°©(g). ë¶„ëŸ‰ ë¯¸ëª…ì‹œì‹œ ì¼ë°˜ì ì¸ 1ì¸ë¶„ ê¸°ì¤€. ìˆ«ìëŠ” ì†Œìˆ˜ì  1ìë¦¬.`,
        messages: [{ role: "user", content: `ë‹¤ìŒ ìŒì‹ì˜ ì˜ì–‘ì •ë³´ë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”: ${foodText}` }]
      })
    });

    const data = await response.json();
    const text = data.content?.[0]?.text || "";
    const clean = text.replace(/```json|```/g, "").trim();
    const parsed = JSON.parse(clean);
    window._aiResults = { items: parsed.items, mealType: state.mealType, date: state.mealDate };

    const itemRows = parsed.items.map((item, i) => `
      <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)">
        <div style="flex:1;min-width:0">
          <div style="font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${item.name}</div>
          <div style="font-size:11px;color:var(--muted)">${item.amount} Â· íƒ„${item.carb}g Â· ë‹¨${item.pro}g Â· ì§€${item.fat}g</div>
        </div>
        <div style="display:flex;align-items:center;gap:8px;margin-left:8px;flex-shrink:0">
          <span style="color:var(--accent);font-weight:700;font-size:13px">${item.cal}kcal</span>
          <button id="ai-add-${i}" onclick="addAIFood(${i})" style="background:var(--accent);color:var(--bg);border-radius:8px;padding:4px 10px;font-size:12px;font-weight:700;font-family:inherit">ì¶”ê°€</button>
        </div>
      </div>
    `).join("");

    const totalRow = parsed.items.length > 1 ? `
      <div style="padding:10px 0 4px;display:flex;justify-content:space-between;align-items:center">
        <div style="font-size:13px;font-weight:700">ì „ì²´ í•©ê³„</div>
        <div style="text-align:right">
          <div style="color:var(--accent);font-weight:700">${parsed.total.cal}kcal</div>
          <div style="font-size:11px;color:var(--muted)">íƒ„${parsed.total.carb}g Â· ë‹¨${parsed.total.pro}g Â· ì§€${parsed.total.fat}g</div>
        </div>
      </div>
      <button onclick="addAllAIFoods()" style="width:100%;background:var(--accent);color:var(--bg);border-radius:10px;padding:10px;font-weight:700;font-size:14px;font-family:inherit;margin-top:4px">ì „ì²´ í•œë²ˆì— ì¶”ê°€</button>
    ` : "";

    resultDiv.innerHTML = `<div style="background:var(--bg);border-radius:10px;padding:4px 8px">${itemRows}${totalRow}</div>`;

  } catch (err) {
    resultDiv.innerHTML = `<div style="color:var(--red);font-size:13px;padding:8px 0">âš ï¸ ë¶„ì„ ì‹¤íŒ¨. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>`;
  } finally {
    btn.disabled = false;
    btn.textContent = "ë¶„ì„";
  }
}

function addAIFood(idx) {
  if (!window._aiResults) return;
  const item = window._aiResults.items[idx];
  state.mealLogs.push({
    id: Date.now() + idx,
    date: window._aiResults.date,
    mealType: window._aiResults.mealType,
    name: item.name + (item.amount && item.amount !== "1ì¸ë¶„" ? ` (${item.amount})` : ""),
    cal: Math.round(item.cal), carb: Math.round(item.carb),
    pro: Math.round(item.pro), fat: Math.round(item.fat)
  });
  saveMeals();
  const btn = document.getElementById(`ai-add-${idx}`);
  if (btn) { btn.textContent = "âœ“"; btn.style.background = "var(--green)"; btn.disabled = true; }
  // Update summary bar without full re-render
  const summary = document.querySelector("#content .card");
  if (summary) { const dayMeals = state.mealLogs.filter(m => m.date === state.mealDate); const tc = dayMeals.reduce((s,m)=>s+m.cal,0); const tcarb = dayMeals.reduce((s,m)=>s+(m.carb||0),0); const tpro = dayMeals.reduce((s,m)=>s+(m.pro||0),0); const tfat = dayMeals.reduce((s,m)=>s+(m.fat||0),0); }
  updateHeader();
}

function addAllAIFoods() {
  if (!window._aiResults) return;
  window._aiResults.items.forEach((item, i) => {
    state.mealLogs.push({
      id: Date.now() + i,
      date: window._aiResults.date,
      mealType: window._aiResults.mealType,
      name: item.name + (item.amount && item.amount !== "1ì¸ë¶„" ? ` (${item.amount})` : ""),
      cal: Math.round(item.cal), carb: Math.round(item.carb),
      pro: Math.round(item.pro), fat: Math.round(item.fat)
    });
  });
  saveMeals();
  state.showMealAdd = false;
  window._aiResults = null;
  render();
}

// ========= INIT =========
window.addEventListener("DOMContentLoaded", () => {
  loadState();
  document.getElementById("loading").style.display = "none";
  document.getElementById("app").style.display = "block";
  render();
});

// Service Worker registration
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}
</script>
</body>
</html>
